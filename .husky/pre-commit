#!/bin/sh
# 优化的 pre-commit 钩子，提供详细的错误报告

set -e

echo "🔍 检查待提交文件..."

# 只检查代码相关文件类型
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(js|jsx|ts|tsx|vue|css|scss|less|json|md)$' || true)

if [ -z "$STAGED_FILES" ]; then
  echo "✅ 没有需要检查的代码文件"
  exit 0
fi

echo "📝 待处理文件: $(echo "$STAGED_FILES" | wc -l) 个"
echo "$STAGED_FILES" | sed 's/^/  - /'
echo ""

# 检查是否有未暂存的更改
HAS_UNSTAGED_CHANGES=false
if [ -n "$(git diff --name-only)" ]; then
  HAS_UNSTAGED_CHANGES=true
fi

# 保存工作区状态
if [ "$HAS_UNSTAGED_CHANGES" = true ]; then
  echo "💾 保存工作区状态..."
  if ! git stash push --quiet --keep-index --message "pre-commit-stash" 2>/dev/null; then
    echo "⚠️  警告：无法保存工作区状态，继续执行..."
    HAS_UNSTAGED_CHANGES=false
  fi
fi

# 记录检查前的暂存区哈希
STAGED_HASH_BEFORE=$(git diff --cached | sha256sum | cut -d' ' -f1 2>/dev/null || git diff --cached | shasum -a 256 | cut -d' ' -f1)

# 运行代码检查和修复（仅针对暂存文件）
echo "🔧 运行代码检查和修复..."

# 捕获 stdout 和 stderr 并保留退出码
set +e
# 只对暂存文件进行 lint 和格式化修复
CHECK_OUTPUT=$(echo "$STAGED_FILES" | xargs pnpm check-fix 2>&1)
CHECK_EXIT_CODE=$?
set -e

# 重新暂存可能被修改的文件
if [ -n "$STAGED_FILES" ]; then
  echo "$STAGED_FILES" | while IFS= read -r file; do
    if [ -f "$file" ]; then
      git add "$file" 2>/dev/null || true
    fi
  done
fi

# 记录检查后的暂存区哈希
STAGED_HASH_AFTER=$(git diff --cached | sha256sum | cut -d' ' -f1 2>/dev/null || git diff --cached | shasum -a 256 | cut -d' ' -f1)

# 恢复工作目录状态
if [ "$HAS_UNSTAGED_CHANGES" = true ]; then
  echo "🔄 恢复工作区状态..."
  if ! git stash pop --quiet 2>/dev/null; then
    echo "⚠️  警告：无法自动恢复工作区状态"
    echo "   请手动运行: git stash pop"
    echo ""
  fi
fi

# 报告结果
echo ""
echo "=== 🔍 代码检查结果 ==="

if [ $CHECK_EXIT_CODE -eq 0 ]; then
  if [ "$STAGED_HASH_BEFORE" != "$STAGED_HASH_AFTER" ]; then
    echo "✅ 代码格式化完成"
    echo "🔧 已修复以下文件:"
    echo "$STAGED_FILES" | sed 's/^/  ✨ /'
  else
    echo "✅ 代码格式良好，类型检查通过"
  fi
else
  echo "❌ 代码检查失败！"
  echo ""

  # 解析并分类显示错误
  # TypeScript 错误特征：error TS 错误码或 Type error
  TS_ERRORS=$(echo "$CHECK_OUTPUT" | grep -E "(error TS[0-9]+|Type error:)" || true)

  if [ -n "$TS_ERRORS" ]; then
    echo "📋 TypeScript 类型错误:"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    printf '%s\n' "$TS_ERRORS"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
  fi

  echo "🔧 修复建议:"
  echo "   1. 修复 TypeScript 类型错误（需要手动修复）"
  echo "   2. 运行 'pnpm check' 查看完整的类型错误信息"
  echo "   3. 运行 'pnpm run check-fix' 检查所有问题"
  echo "   4. 修复后重新添加文件: git add <文件名>"
  echo "   5. 重新提交: git commit"
  echo ""
  echo "❌ 提交已阻止，请修复错误后重新提交"
  exit $CHECK_EXIT_CODE
fi

echo ""
echo "🎉 Pre-commit 检查完成！"
